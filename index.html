<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì›ì˜ ë„“ì´ì™€ ì›ì£¼ìœ¨ ì‹œê°í™” í•™ìŠµ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700;800&display=swap');
        
        body {
            font-family: 'Nanum Gothic', sans-serif;
            touch-action: none; 
            overscroll-behavior: none; /* ë§¥/ëª¨ë°”ì¼ ìŠ¤ì™€ì´í”„ ë°”ìš´ìŠ¤ ë°©ì§€ */
        }

        /* íƒ­ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .tab-btn {
            transition: all 0.2s;
            border-bottom: 4px solid transparent;
        }
        .tab-btn.active {
            border-bottom-color: #3b82f6; /* blue-500 */
            color: #1d4ed8; /* blue-700 */
            background-color: #eff6ff; /* blue-50 */
        }
        
        /* ìº”ë²„ìŠ¤ ì»¤ì„œ */
        .drag-cursor { cursor: grab; }
        .drag-cursor:active { cursor: grabbing; }

        /* ìŠ¬ë¼ì´ë” ìŠ¤íƒ€ì¼ */
        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            margin-top: -8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #cbd5e1;
            border-radius: 2px;
        }

        /* ë§í’ì„  ìŠ¤íƒ€ì¼ */
        .bubble {
            position: absolute;
            background: rgba(255, 255, 255, 0.9);
            padding: 5px 10px;
            border-radius: 10px;
            border: 2px solid #3b82f6;
            font-weight: bold;
            color: #1e3a8a;
            pointer-events: none;
            font-size: 0.9rem;
            transform: translate(-50%, -100%);
            white-space: nowrap;
            z-index: 20;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .bubble::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 50%;
            margin-left: -6px;
            border-width: 6px 6px 0;
            border-style: solid;
            border-color: #3b82f6 transparent transparent transparent;
        }
    </style>
</head>
<body class="bg-slate-50 h-screen flex flex-col overflow-hidden">

    <!-- í—¤ë” -->
    <header class="bg-indigo-600 text-white p-3 shadow-lg flex-none z-20">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <h1 class="text-xl md:text-2xl font-extrabold flex items-center gap-2">
                <i class="fas fa-shapes"></i> ì›ì˜ ë„“ì´ íƒí—˜ëŒ€
            </h1>
            <div class="text-xs md:text-sm bg-indigo-700 px-3 py-1 rounded-full border border-indigo-400">
                6í•™ë…„ 2í•™ê¸°
            </div>
        </div>
    </header>

    <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
    <nav class="bg-white border-b border-slate-200 flex-none z-10">
        <div class="max-w-6xl mx-auto flex justify-center text-sm md:text-base font-bold text-slate-500">
            <button onclick="switchTab('circumference')" id="tab-circumference" class="tab-btn active flex-1 py-3 text-center hover:bg-slate-50">
                <i class="fas fa-circle-notch mr-1"></i> 1. ì›ì£¼ì™€ ì›ì£¼ìœ¨
            </button>
            <button onclick="switchTab('area-rect')" id="tab-area-rect" class="tab-btn flex-1 py-3 text-center hover:bg-slate-50">
                <i class="fas fa-vector-square mr-1"></i> 2. ë„“ì´ (ì§ì‚¬ê°í˜•)
            </button>
            <button onclick="switchTab('area-tri')" id="tab-area-tri" class="tab-btn flex-1 py-3 text-center hover:bg-slate-50">
                <i class="fas fa-caret-up mr-1"></i> 3. ë„“ì´ (ì‚¼ê°í˜•)
            </button>
        </div>
    </nav>

    <!-- ì»¨íŠ¸ë¡¤ íŒ¨ë„ (ëª¨ë“œì— ë”°ë¼ ë‚´ìš© ë³€ê²½) -->
    <section class="bg-white p-3 border-b border-slate-200 flex-none z-10 shadow-sm">
        <div class="max-w-6xl mx-auto flex flex-col md:flex-row gap-4 items-center justify-center md:justify-between h-auto md:h-12">
            
            <!-- ê³µí†µ: ì§€ë¦„ ì…ë ¥ (ìˆ˜ì • ê°€ëŠ¥) -->
            <div id="common-controls" class="flex items-center gap-2">
                <label class="font-bold text-slate-700 text-sm">ì§€ë¦„:</label>
                <div class="flex items-center bg-white border-2 border-slate-300 rounded px-2 py-1 focus-within:border-blue-500">
                    <input type="number" id="diameterInput" value="4" min="2" max="8" step="0.1"
                           class="w-16 bg-transparent text-center font-bold text-slate-700 outline-none"
                           onchange="updateDiameter()">
                    <span class="text-xs text-slate-500">cm</span>
                </div>
            </div>

            <!-- ëª¨ë“œë³„ ì»¨íŠ¸ë¡¤ -->
            <div class="flex-grow flex justify-center items-center w-full md:w-auto">
                
                <!-- 1. ì›ì£¼ ëª¨ë“œ ì»¨íŠ¸ë¡¤ -->
                <div id="ctrl-circumference" class="control-group flex gap-2">
                    <span class="text-sm text-slate-500 self-center mr-2">ì›ì„ ë“œë˜ê·¸í•˜ì—¬ êµ´ë¦¬ì„¸ìš”!</span>
                    <button onclick="resetPosition()" class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-1 rounded text-sm font-bold shadow">
                        <i class="fas fa-undo"></i> ì²˜ìŒìœ¼ë¡œ
                    </button>
                </div>

                <!-- 2. ì§ì‚¬ê°í˜• ëª¨ë“œ ì»¨íŠ¸ë¡¤ -->
                <div id="ctrl-area-rect" class="control-group hidden flex flex-col md:flex-row gap-3 w-full md:w-auto items-center">
                    <div class="flex gap-1 overflow-x-auto max-w-[300px] md:max-w-none pb-1 md:pb-0 hide-scrollbar">
                        <button onclick="setSplit(8)" class="split-btn bg-slate-200 hover:bg-blue-100 text-slate-700 px-2 py-1 rounded text-xs font-bold transition border border-slate-300">8ì¡°ê°</button>
                        <button onclick="setSplit(16)" class="split-btn bg-slate-200 hover:bg-blue-100 text-slate-700 px-2 py-1 rounded text-xs font-bold transition border border-slate-300">16</button>
                        <button onclick="setSplit(32)" class="split-btn bg-slate-200 hover:bg-blue-100 text-slate-700 px-2 py-1 rounded text-xs font-bold transition border border-slate-300">32</button>
                        <button onclick="setSplit(64)" class="split-btn bg-slate-200 hover:bg-blue-100 text-slate-700 px-2 py-1 rounded text-xs font-bold transition border border-slate-300">64</button>
                        <button onclick="setSplit(128)" class="split-btn bg-slate-200 hover:bg-blue-100 text-slate-700 px-2 py-1 rounded text-xs font-bold transition border border-slate-300">128</button>
                    </div>
                    <div class="flex items-center gap-2 border-l pl-3 border-slate-300">
                        <label class="text-xs font-bold text-blue-600 whitespace-nowrap">ë³€í˜• ê³¼ì •:</label>
                        <input type="range" id="rect-slider" min="0" max="100" value="0" class="w-32 md:w-48" oninput="updateTransform(this.value)">
                    </div>
                </div>

                <!-- 3. ì‚¼ê°í˜• ëª¨ë“œ ì»¨íŠ¸ë¡¤ -->
                <div id="ctrl-area-tri" class="control-group hidden flex flex-col md:flex-row gap-3 w-full md:w-auto items-center">
                     <div class="flex gap-1 overflow-x-auto max-w-[300px] md:max-w-none pb-1 md:pb-0 hide-scrollbar">
                        <button onclick="setSplit(4)" class="split-btn bg-slate-200 hover:bg-blue-100 text-slate-700 px-2 py-1 rounded text-xs font-bold transition border border-slate-300">4ê°œ</button>
                        <button onclick="setSplit(8)" class="split-btn bg-slate-200 hover:bg-blue-100 text-slate-700 px-2 py-1 rounded text-xs font-bold transition border border-slate-300">8ê°œ</button>
                        <button onclick="setSplit(16)" class="split-btn bg-slate-200 hover:bg-blue-100 text-slate-700 px-2 py-1 rounded text-xs font-bold transition border border-slate-300">16</button>
                        <button onclick="setSplit(32)" class="split-btn bg-slate-200 hover:bg-blue-100 text-slate-700 px-2 py-1 rounded text-xs font-bold transition border border-slate-300">32</button>
                    </div>
                    <div class="flex items-center gap-2 border-l pl-3 border-slate-300">
                        <label class="text-xs font-bold text-green-600 whitespace-nowrap">í¼ì¹˜ê¸°:</label>
                        <input type="range" id="tri-slider" min="0" max="100" value="0" class="w-32 md:w-48" oninput="updateTransform(this.value)">
                    </div>
                </div>

            </div>
        </div>
    </section>

    <!-- ë©”ì¸ ìº”ë²„ìŠ¤ ì˜ì—­ -->
    <main class="flex-grow relative bg-slate-100 overflow-hidden flex flex-col">
        
        <!-- ì„¤ëª… íŒ¨ë„ (ìƒë‹¨ ì¤‘ì•™ í”Œë¡œíŒ…) -->
        <div id="info-panel" class="absolute top-4 left-1/2 transform -translate-x-1/2 z-10 w-11/12 max-w-3xl pointer-events-none transition-opacity duration-300">
            <!-- JSë¡œ ë‚´ìš© ì—…ë°ì´íŠ¸ -->
        </div>

        <!-- êµ´ë¦¬ê¸° ëª¨ë“œìš© ê±°ë¦¬ í‘œì‹œ ë§í’ì„  (ë™ì  ìœ„ì¹˜) -->
        <div id="distance-bubble" class="bubble hidden">0.0 cm</div>

        <!-- ìº”ë²„ìŠ¤ ì»¨í…Œì´ë„ˆ (ìŠ¤í¬ë¡¤ ì—†ìŒ) -->
        <div id="canvas-wrapper" class="w-full h-full overflow-hidden relative bg-white flex items-center justify-center">
            <canvas id="mainCanvas"></canvas>
        </div>
    </main>

    <script>
        // --- ì „ì—­ ë³€ìˆ˜ ë° ì„¤ì • ---
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        const wrapper = document.getElementById('canvas-wrapper');
        const bubble = document.getElementById('distance-bubble');
        
        let currentTab = 'circumference'; 
        
        // ë™ì  ìŠ¤ì¼€ì¼ë§ì„ ìœ„í•œ ë³€ìˆ˜
        let pixelsPerCm = 40; // ê¸°ë³¸ê°’, resize ì‹œ ë³€ê²½ë¨
        let diameterCm = 4; 
        let radiusPx = 0;
        
        // ìœ„ì¹˜ ë³€ìˆ˜ (ë°˜ì‘í˜•)
        let rollX = 0; 
        let rollStartX = 0;
        
        // ë„“ì´ ëª¨ë“œ ë³€ìˆ˜ (ë°˜ì‘í˜•)
        let rectCx = 0;
        let rectStartX = 0;
        let triCx = 0;
        let triCenterX = 0;

        let isDragging = false;
        let isFinished = false; 
        let lastPointerX = 0;

        let splitCount = 8; 
        let transformProgress = 0; 

        // ìƒ‰ìƒ íŒ”ë ˆíŠ¸
        const colors = {
            rectRed: '#ef4444',    // ë¹¨ê°•
            rectBlue: '#3b82f6',   // íŒŒë‘
            accent: '#ef4444',
            bg: '#f8fafc',
            text: '#334155'
        };

        // --- ì´ˆê¸°í™” ë° íƒ­ ê´€ë¦¬ ---
        function init() {
            // ë°˜ì‘í˜• ë¦¬ì‚¬ì´ì¦ˆ
            window.addEventListener('resize', () => {
                resizeCanvas();
            });
            
            switchTab('circumference');
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            canvas.addEventListener('mousedown', onPointerDown);
            canvas.addEventListener('touchstart', onPointerDown, {passive: false});
            window.addEventListener('mousemove', onPointerMove);
            window.addEventListener('touchmove', onPointerMove, {passive: false});
            window.addEventListener('mouseup', onPointerUp);
            window.addEventListener('touchend', onPointerUp);
        }

        // --- í•µì‹¬: í•œ í™”ë©´ì— ë§ì¶”ê¸° ìœ„í•œ ìŠ¤ì¼€ì¼ë§ ê³„ì‚° ---
        function calculateLayout() {
            const w = canvas.width;
            const h = canvas.height;
            
            // 1. í•„ìš”í•œ ì´ ê°€ë¡œ ê¸¸ì´(í”½ì…€) ê³„ì‚° (ê¸°ë³¸ 40px/cm ê¸°ì¤€)
            // (1) ì›ì£¼ ëª¨ë“œ: ì™¼ìª½ì—¬ë°± + ì§€ë¦„*PI + ì˜¤ë¥¸ìª½ì—¬ë°±
            // (2) ì§ì‚¬ê°í˜•: ì™¼ìª½ì› + ì—¬ë°± + ì˜¤ë¥¸ìª½ì§ì‚¬ê°í˜•(PI*R)
            // (3) ì‚¼ê°í˜•: ì™¼ìª½ì› + ì—¬ë°± + ì˜¤ë¥¸ìª½ì‚¼ê°í˜•(2*PI*R) -> ì´ê²Œ ì œì¼ ê¸º
            
            // ì—¬ë°± ë¹„ìœ¨
            const paddingRatio = 0.2; // ì „ì²´ì˜ 20%ëŠ” ì—¬ë°±ìœ¼ë¡œ
            
            // ëª¨ë“œë³„ í•„ìš” ë„ˆë¹„ ê³„ì‚° (ë‹¨ìœ„: cm)
            let neededWidthCm = 0;
            
            // ëª¨ë“  ëª¨ë“œë¥¼ ì•„ìš°ë¥´ëŠ” ì ì ˆí•œ ìŠ¤ì¼€ì¼ ì°¾ê¸°
            // ê°€ì¥ ê¸´ ê²ƒì€ ì‚¼ê°í˜•ì˜ ë°‘ë³€(ì›ì£¼ = ì§€ë¦„*PI)
            // ëŒ€ëµ ì›ì£¼(25cm) + ì—¬ë°±(5cm) = 30cm ì •ë„ê°€ ìµœëŒ€
            const maxNeededCm = (diameterCm * Math.PI) + diameterCm + 2; // ì› + ì›ì£¼ + ì—¬ë°±
            
            // í™”ë©´ ë„ˆë¹„ì— ë§ê²Œ pixelsPerCm ì¡°ì •
            // w = maxNeededCm * pixelsPerCm
            // pixelsPerCm = w / maxNeededCm
            
            // ê¸°ë³¸ 40ì„ ë„˜ì§€ ì•Šë„ë¡ (ë„ˆë¬´ ì»¤ì§€ëŠ” ê²ƒ ë°©ì§€)
            const calculatedPPCM = (w * 0.85) / maxNeededCm; // 85% ë„ˆë¹„ ì‚¬ìš©
            pixelsPerCm = Math.min(40, calculatedPPCM); 
            
            // ìµœì†Œê°’ ë³´ì • (ë„ˆë¬´ ì‘ì•„ì§€ì§€ ì•Šê²Œ)
            if (pixelsPerCm < 15) pixelsPerCm = 15; // ëª¨ë°”ì¼ ìµœì†Œ ê°€ë…ì„±

            // ë°˜ì§€ë¦„ ë“± ì¬ê³„ì‚°
            radiusPx = (diameterCm * pixelsPerCm) / 2;
            
            // ìœ„ì¹˜ ì¢Œí‘œ ì¬ì„¤ì • (í™”ë©´ ë¹„ìœ¨ì— ë”°ë¼ ë°°ì¹˜)
            
            // 1. êµ´ë¦¬ê¸° ëª¨ë“œ ìœ„ì¹˜
            rollStartX = w * 0.15; // í™”ë©´ 15% ì§€ì ì—ì„œ ì‹œì‘
            if (currentTab === 'circumference' && !isDragging && rollX === 0) {
                 rollX = rollStartX; // ì´ˆê¸°í™” ì‹œì—ë§Œ
            } else if (currentTab === 'circumference' && !isDragging) {
                // ë¦¬ì‚¬ì´ì¦ˆ ì‹œ ë¹„ìœ¨ ìœ ì§€ (í˜„ì¬ ì§„í–‰ë„ì— ë”°ë¼)
                // ë³µì¡í•˜ë©´ ê·¸ëƒ¥ ì‹œì‘ì ìœ¼ë¡œ ë¦¬ì…‹í•˜ëŠ”ê²Œ ì•ˆì „í• ìˆ˜ë„ ìˆì§€ë§Œ,
                // ì—¬ê¸°ì„  ë¦¬ì‚¬ì´ì¦ˆ ì‹œ ìœ„ì¹˜ ë³´ì • ìƒëµí•˜ê³  drawì—ì„œ ì²˜ë¦¬
            }

            // 2. ì§ì‚¬ê°í˜• ëª¨ë“œ ìœ„ì¹˜
            rectCx = w * 0.25; // ì™¼ìª½ 25%
            rectStartX = w * 0.6; // ì˜¤ë¥¸ìª½ 60% ì§€ì ì´ ì§ì‚¬ê°í˜• ì¤‘ì‹¬ì´ ë˜ë„ë¡? ì•„ë‹ˆë©´ ì‹œì‘ì ?
            
            // 3. ì‚¼ê°í˜• ëª¨ë“œ ìœ„ì¹˜
            triCx = w * 0.2; // ì™¼ìª½ 20%
            triCenterX = w * 0.6; // ì˜¤ë¥¸ìª½ 60%
        }

        function resizeCanvas() {
            // ìŠ¤í¬ë¡¤ ì—†ì´ ê½‰ ì±„ìš°ê¸°
            canvas.width = wrapper.clientWidth;
            canvas.height = wrapper.clientHeight;
            
            calculateLayout();
            
            // êµ´ë¦¬ê¸° ëª¨ë“œì¼ ë•Œ ìœ„ì¹˜ ë¦¬ì…‹ (í™”ë©´ í¬ê¸° ë°”ë€Œë©´ ì–´ê¸‹ë‚  ìˆ˜ ìˆìœ¼ë¯€ë¡œ)
            if (currentTab === 'circumference') {
               // ì§„í–‰ ì¤‘ì´ì—ˆë‹¤ë©´ ë¹„ìœ¨ ë§ì¶°ì£¼ê³  ì‹¶ì§€ë§Œ, UXìƒ ë¦¬ì…‹ì´ ê¹”ë”í•¨
               if(!isDragging) {
                   rollX = rollStartX;
                   isFinished = false;
                   bubble.classList.add('hidden');
               }
            }
            
            draw();
        }

        function updateDiameter() {
            const input = document.getElementById('diameterInput');
            let val = parseFloat(input.value);
            if (isNaN(val)) val = 4;
            if (val < 2) val = 2;
            if (val > 8) val = 8;
            val = Math.round(val * 10) / 10;
            
            input.value = val;
            diameterCm = val;
            
            calculateLayout(); // ì§€ë¦„ ë°”ë€Œë©´ ìŠ¤ì¼€ì¼ ë‹¤ì‹œ ê³„ì‚°
            resetPosition(); 
            updateInfoPanel();
        }

        function switchTab(tabName) {
            currentTab = tabName;
            
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            document.querySelectorAll('.control-group').forEach(grp => grp.classList.add('hidden'));
            document.getElementById(`ctrl-${tabName}`).classList.remove('hidden');

            // íƒ­ ë³€ê²½ ì‹œ ë¦¬ì…‹
            calculateLayout();
            rollX = rollStartX;
            transformProgress = 0;
            isFinished = false;
            bubble.classList.add('hidden'); 

            if(tabName === 'area-rect') {
                splitCount = 8;
                document.getElementById('rect-slider').value = 0;
            } else if (tabName === 'area-tri') {
                splitCount = 4;
                document.getElementById('tri-slider').value = 0;
            }

            updateInfoPanel();
            draw();
        }

        function setSplit(n) {
            splitCount = n;
            draw();
            updateInfoPanel();
        }

        function updateTransform(val) {
            transformProgress = val / 100;
            draw();
        }

        // --- ê·¸ë¦¬ê¸° ë£¨í”„ ---
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (currentTab === 'circumference') {
                drawCircumferenceMode();
            } else if (currentTab === 'area-rect') {
                drawAreaRectMode();
            } else if (currentTab === 'area-tri') {
                drawAreaTriMode();
            }
        }

        // --- 1. ì›ì£¼ìœ¨ (êµ´ë¦¬ê¸°) ëª¨ë“œ ---
        function drawCircumferenceMode() {
            const groundY = canvas.height * 0.7;
            const dist = rollX - rollStartX;
            const distCm = dist / pixelsPerCm; // ìŠ¤ì¼€ì¼ ì ìš©
            const rotation = dist / radiusPx;
            const circumferencePx = diameterCm * Math.PI * pixelsPerCm;

            if (dist > 0 && !isFinished) {
                const canvasRect = canvas.getBoundingClientRect();
                bubble.style.left = (canvasRect.left + rollX) + 'px';
                bubble.style.top = (canvasRect.top + groundY - radiusPx - 15) + 'px';
                bubble.innerText = distCm.toFixed(1) + " cm";
                bubble.classList.remove('hidden');
            } else {
                bubble.classList.add('hidden');
            }

            // ë°”ë‹¥ì„ 
            ctx.beginPath();
            ctx.moveTo(0, groundY);
            ctx.lineTo(canvas.width, groundY);
            ctx.strokeStyle = '#94a3b8';
            ctx.lineWidth = 2;
            ctx.stroke();

            // ëˆˆê¸ˆì (ë™ì  ê°„ê²©)
            // í™”ë©´ì´ ì¢ìœ¼ë©´ ëˆˆê¸ˆ ê°„ê²©ì„ ë„“í˜ (5cm ë‹¨ìœ„ ë“±)
            // pixelsPerCmê°€ ì‘ì„ìˆ˜ë¡ ëˆˆê¸ˆì´ ì´˜ì´˜í•´ì§€ë¯€ë¡œ ë Œë”ë§ ë¶€í•˜ ë°©ì§€
            const tickStep = pixelsPerCm < 20 ? 5 : 1; 

            ctx.fillStyle = "#475569";
            ctx.font = "bold 12px sans-serif";
            ctx.textAlign = "center";
            
            // ì „ì²´ ìº”ë²„ìŠ¤ ë„ˆë¹„ì— ëŒ€í•´ ëˆˆê¸ˆ ê·¸ë¦¬ê¸° (ì‹œì‘ì  ê¸°ì¤€)
            const maxCm = (canvas.width - rollStartX) / pixelsPerCm;
            
            for(let i=0; i <= maxCm; i += tickStep) {
                const tx = rollStartX + (i * pixelsPerCm);
                ctx.beginPath();
                ctx.moveTo(tx, groundY);
                ctx.lineTo(tx, groundY + 10);
                ctx.strokeStyle = "#64748b";
                ctx.lineWidth = 1;
                ctx.stroke();
                
                // 5cm ë‹¨ìœ„ í˜¹ì€ ê³µê°„ì´ ì¶©ë¶„í•˜ë©´ í‘œì‹œ
                if (i % 5 === 0 || tickStep > 1) {
                    ctx.fillText(i, tx, groundY + 25);
                }
            }

            // êµ´ëŸ¬ê°„ ìêµ­
            if(dist > 0) {
                ctx.beginPath();
                ctx.moveTo(rollStartX, groundY);
                ctx.lineTo(rollX, groundY);
                ctx.strokeStyle = colors.accent;
                ctx.lineWidth = 6;
                ctx.lineCap = 'round';
                ctx.stroke();
            }

            // ëª©í‘œ ì§€ì 
            const targetX = rollStartX + circumferencePx;
            ctx.beginPath();
            ctx.moveTo(targetX, groundY - 30);
            ctx.lineTo(targetX, groundY + 30);
            ctx.strokeStyle = '#3b82f6';
            ctx.setLineDash([5,5]);
            ctx.lineWidth = 2;
            ctx.stroke();
            ctx.setLineDash([]);
            ctx.fillStyle = '#3b82f6';
            ctx.fillText("í•œ ë°”í€´", targetX, groundY - 40);

            // ì› ê·¸ë¦¬ê¸°
            ctx.save();
            ctx.translate(rollX, groundY - radiusPx);
            ctx.rotate(rotation);
            
            ctx.beginPath();
            ctx.arc(0, 0, radiusPx, 0, Math.PI * 2);
            ctx.fillStyle = 'rgba(59, 130, 246, 0.1)';
            ctx.fill();
            ctx.strokeStyle = '#2563eb';
            ctx.lineWidth = 3;
            ctx.stroke();
            
            // ë°”ë‹¥ì 
            ctx.beginPath();
            ctx.arc(0, radiusPx, 5, 0, Math.PI*2); 
            ctx.fillStyle = colors.accent;
            ctx.fill();

            ctx.restore();
            
            // ì‹œì‘ì  í‘œì‹œ
            ctx.fillStyle = "#333";
            ctx.fillText("ì¶œë°œ", rollStartX, groundY - 50);

            // ì™„ë£Œ ìƒíƒœ ì²´í¬
            if (dist >= circumferencePx - 1 && !isFinished) { 
                isFinished = true;
                updateInfoPanel(); 
            }
        }

        // --- 2. ì›ì˜ ë„“ì´ (ì§ì‚¬ê°í˜•) ëª¨ë“œ ---
        function drawAreaRectMode() {
            const cy = canvas.height / 2;
            
            ctx.save();
            ctx.translate(rectCx, cy);
            
            ctx.beginPath();
            ctx.arc(0, 0, radiusPx, 0, Math.PI*2);
            ctx.strokeStyle = '#cbd5e1';
            ctx.stroke();

            const angleStep = (Math.PI * 2) / splitCount;
            const rectTotalWidth = Math.PI * radiusPx;
            const pieceWidth = rectTotalWidth / (splitCount / 2); 

            for (let i = 0; i < splitCount; i++) {
                const startAngle = i * angleStep;
                const endAngle = startAngle + angleStep;
                const midAngle = startAngle + angleStep / 2;

                const t = transformProgress;
                
                const colIndex = Math.floor(i / 2); 
                let rectX_local = colIndex * pieceWidth;
                if (i % 2 !== 0) {
                    rectX_local += (pieceWidth / 2);
                }

                // rectStartXëŠ” í™”ë©´ì˜ 60% ì§€ì . ì—¬ê¸°ì„œ ì§ì‚¬ê°í˜•ì˜ ì¤‘ì‹¬ì´ ë˜ë„ë¡ ë°°ì¹˜
                // targetX = (í™”ë©´ìƒ ì§ì‚¬ê°í˜• ì¤‘ì‹¬ - í™”ë©´ìƒ ì› ì¤‘ì‹¬) + ë¡œì»¬ ìœ„ì¹˜ - ì§ì‚¬ê°í˜• ì ˆë°˜
                const targetX = (rectStartX - rectCx) + rectX_local - (rectTotalWidth / 2) + (pieceWidth/2);
                
                const targetY = (i % 2 === 0) ? (radiusPx/2) : -(radiusPx/2);
                const targetRot = (i % 2 === 0) ? -Math.PI/2 : Math.PI/2;
                
                const curX = targetX * t; 
                const curY = targetY * t;
                
                ctx.save();
                ctx.translate(curX, curY);
                ctx.rotate( (targetRot - midAngle) * t );

                ctx.beginPath();
                ctx.moveTo(0, 0);
                ctx.arc(0, 0, radiusPx, startAngle, endAngle);
                ctx.closePath();
                
                ctx.fillStyle = (i % 2 === 0) ? colors.rectRed : colors.rectBlue;
                ctx.fill();
                // ì¡°ê°ì´ ì‘ì•„ì§€ë©´ ì„  ë‘ê»˜ë„ ì¤„ì„
                if(splitCount < 64) {
                    ctx.strokeStyle = "white";
                    ctx.lineWidth = pixelsPerCm > 20 ? 1 : 0.5;
                    ctx.stroke();
                }
                
                ctx.restore();
            }
            ctx.restore();

            if (transformProgress > 0.8) {
                const rectW = Math.PI * radiusPx;
                const finalStartX = rectStartX - (rectW/2) + (rectTotalWidth / splitCount / 2); 
                
                // ê°€ë¡œ ë¼ë²¨
                const labelY = cy + radiusPx/2 + 25;
                ctx.beginPath();
                ctx.moveTo(finalStartX, labelY);
                ctx.lineTo(finalStartX + rectW, labelY);
                ctx.strokeStyle = '#334155';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                ctx.beginPath();
                ctx.moveTo(finalStartX, labelY - 5);
                ctx.lineTo(finalStartX, labelY + 5);
                ctx.moveTo(finalStartX + rectW, labelY - 5);
                ctx.lineTo(finalStartX + rectW, labelY + 5);
                ctx.stroke();

                ctx.fillStyle = '#334155';
                ctx.font = "bold 12px sans-serif";
                ctx.textAlign = 'center';
                ctx.fillText("ê°€ë¡œ = ì›ì£¼ Ã— 1/2", finalStartX + rectW/2, labelY + 15);

                // ì„¸ë¡œ ë¼ë²¨
                const labelX = finalStartX + rectW + 10;
                const topY = cy - radiusPx/2;
                const bottomY = cy + radiusPx/2;
                
                ctx.beginPath();
                ctx.moveTo(labelX, topY);
                ctx.lineTo(labelX, bottomY);
                ctx.stroke();
                
                ctx.beginPath(); 
                ctx.moveTo(labelX - 5, topY);
                ctx.lineTo(labelX + 5, topY);
                ctx.moveTo(labelX - 5, bottomY);
                ctx.lineTo(labelX + 5, bottomY);
                ctx.stroke();

                ctx.textAlign = 'left';
                ctx.fillText("ì„¸ë¡œ = (ë°˜ì§€ë¦„)", labelX + 8, cy + 4);
            }
        }

        // --- 3. ì›ì˜ ë„“ì´ (ì‚¼ê°í˜•) ëª¨ë“œ ---
        function drawAreaTriMode() {
            const cy = canvas.height * 0.75; 
            
            // ë°”ë‹¥ì„ 
            ctx.beginPath();
            ctx.moveTo(0, cy);
            ctx.lineTo(canvas.width, cy);
            ctx.strokeStyle = '#cbd5e1';
            ctx.stroke();

            const ringWidth = radiusPx / splitCount;

            for (let i = 0; i < splitCount; i++) {
                const currentOuterR = radiusPx - (i * ringWidth); 
                const midR = currentOuterR - (ringWidth/2);
                
                const stripLen = 2 * Math.PI * midR; 
                
                const colorVal = 100 + (i * (155/splitCount));
                const color = `rgb(${colorVal}, ${100}, 255)`;

                const t = transformProgress;
                
                // ëª©í‘œ ìœ„ì¹˜: ì‚¼ê°í˜•ì˜ ì•„ë˜ìª½ë¶€í„° ìŒ“ì„
                const targetY = cy - (i * ringWidth) - (ringWidth/2);
                
                const circleCenterY = cy - radiusPx;
                const startLegY = circleCenterY + midR;
                
                const curLegY = startLegY + (targetY - startLegY) * t;

                // X ì´ë™: triCx -> triCenterX
                const curX = triCx + (triCenterX - triCx) * t;

                const maxAngle = 2 * Math.PI;
                const minAngle = 0.01; 
                const angle = maxAngle * (1 - t) + minAngle * t;
                
                const r_morph = stripLen / angle;
                const sag = r_morph * (1 - Math.cos(angle / 2));
                
                const arcCX = curX;
                const arcCY = curLegY - sag + r_morph;
                
                ctx.beginPath();
                ctx.strokeStyle = color;
                ctx.lineWidth = ringWidth - 0.5; 
                if (ctx.lineWidth < 1) ctx.lineWidth = 1;
                
                ctx.arc(arcCX, arcCY, r_morph, -Math.PI/2 - angle/2, -Math.PI/2 + angle/2);
                ctx.stroke();

                // í…ìŠ¤íŠ¸ í‘œì‹œ
                if (i === 0 && t > 0.9) {
                    ctx.fillStyle = "#333";
                    ctx.textAlign = "center";
                    ctx.font = "bold 12px sans-serif";
                    ctx.fillText("ë°‘ë³€ = ì›ì£¼", triCenterX, cy + 20);
                }
                if (i === splitCount - 1 && t > 0.9) {
                    const rightX = triCenterX + (stripLen/2) + 20;
                    ctx.beginPath();
                    ctx.moveTo(rightX, cy);
                    ctx.lineTo(rightX, cy - radiusPx);
                    ctx.lineWidth = 1;
                    ctx.strokeStyle = "#333";
                    ctx.stroke();
                    
                    ctx.beginPath();
                    ctx.moveTo(rightX-5, cy);
                    ctx.lineTo(rightX+5, cy);
                    ctx.moveTo(rightX-5, cy - radiusPx);
                    ctx.lineTo(rightX+5, cy - radiusPx);
                    ctx.stroke();

                    ctx.textAlign = "left";
                    ctx.fillText("ë†’ì´ = (ë°˜ì§€ë¦„)", rightX + 8, cy - radiusPx/2);
                }
            }
        }

        // --- ì •ë³´ íŒ¨ë„ ì—…ë°ì´íŠ¸ ---
        function updateInfoPanel() {
            const panel = document.getElementById('info-panel');
            let html = '';

            if (currentTab === 'circumference') {
                if (!isFinished) {
                    html = `
                        <div class="bg-white/95 backdrop-blur rounded-xl p-4 shadow-xl border border-indigo-200 text-center">
                            <h2 class="text-lg font-bold text-slate-800">ì§€ë¦„ì´ ${diameterCm}cmì¸ ì›</h2>
                            <p class="text-sm text-slate-600 mt-1">ì›ì„ ë“œë˜ê·¸í•˜ì—¬ ëê¹Œì§€ êµ´ë ¤ë³´ì„¸ìš”.</p>
                            <div class="mt-2 text-lg font-bold text-indigo-600 bg-indigo-50 py-2 rounded-lg">
                                ì›ì£¼ìœ¨ = ì›ì£¼ Ã· ì§€ë¦„
                            </div>
                        </div>
                    `;
                } else {
                    const circumference = (diameterCm * Math.PI).toFixed(4);
                    html = `
                        <div class="bg-white/95 backdrop-blur rounded-xl p-4 shadow-xl border-2 border-indigo-500 text-center">
                            <h2 class="text-lg font-bold text-slate-800 mb-2">ğŸ‰ ì¸¡ì • ì™„ë£Œ!</h2>
                            <div class="flex flex-wrap justify-center gap-4 text-sm md:text-base">
                                <div class="bg-slate-100 px-3 py-1 rounded">
                                    <span class="text-slate-500">ì›ì£¼ = </span>
                                    <span class="font-bold text-slate-900">${circumference} cm</span>
                                </div>
                                <div class="bg-slate-100 px-3 py-1 rounded">
                                    <span class="text-slate-500">ì§€ë¦„ = </span>
                                    <span class="font-bold text-slate-900">${diameterCm} cm</span>
                                </div>
                                <div class="bg-indigo-100 px-3 py-1 rounded border border-indigo-200">
                                    <span class="text-indigo-600 font-bold">ì›ì£¼ìœ¨ = 3.1416</span>
                                </div>
                            </div>
                            <div class="mt-2 text-xs text-slate-500">
                                (ì›ì£¼ Ã· ì§€ë¦„ = 3.141592...)
                            </div>
                        </div>
                    `;
                }
            } else if (currentTab === 'area-rect') {
                html = `
                    <div class="bg-white/95 backdrop-blur rounded-xl p-3 shadow-xl border border-blue-200 text-left w-full">
                        <h2 class="text-base font-bold text-slate-800 text-center mb-1">ì§ì‚¬ê°í˜•ì„ ì´ìš©í•œ ì›ì˜ ë„“ì´</h2>
                        <div class="text-xs md:text-sm text-slate-700 space-y-1 bg-slate-50 p-2 rounded-lg border border-slate-200">
                            <p class="font-bold text-slate-900">ë„“ì´ = ê°€ë¡œ Ã— ì„¸ë¡œ</p>
                            <p class="pl-2">= (ì›ì£¼ Ã— 1/2) Ã— (ë°˜ì§€ë¦„)</p>
                            <p class="pl-2">= <span class="text-red-600 font-extrabold">(ë°˜ì§€ë¦„) Ã— 3.14 Ã— (ë°˜ì§€ë¦„)</span></p>
                            <div class="mt-1 text-center font-bold text-indigo-700 bg-indigo-100 py-1 rounded">
                                âˆ´ ì›ì˜ ë„“ì´ = (ë°˜ì§€ë¦„) Ã— (ë°˜ì§€ë¦„) Ã— 3.14
                            </div>
                        </div>
                    </div>
                `;
            } else if (currentTab === 'area-tri') {
                html = `
                    <div class="bg-white/95 backdrop-blur rounded-xl p-3 shadow-xl border border-purple-200 text-left w-full">
                        <h2 class="text-base font-bold text-slate-800 text-center mb-1">ì‚¼ê°í˜•ì„ ì´ìš©í•œ ì›ì˜ ë„“ì´</h2>
                        <div class="text-xs md:text-sm text-slate-700 space-y-1 bg-slate-50 p-2 rounded-lg border border-slate-200">
                            <p class="font-bold text-slate-900">ë„“ì´ = ë°‘ë³€ Ã— ë†’ì´ Ã· 2</p>
                            <p class="pl-2">= ì›ì£¼ Ã— (ë°˜ì§€ë¦„) Ã· 2</p>
                            <p class="pl-2">= <span class="text-red-600 font-extrabold">(ë°˜ì§€ë¦„) Ã— 3.14 Ã— (ë°˜ì§€ë¦„)</span></p>
                            <div class="mt-1 text-center font-bold text-indigo-700 bg-indigo-100 py-1 rounded">
                                âˆ´ ì›ì˜ ë„“ì´ = (ë°˜ì§€ë¦„) Ã— (ë°˜ì§€ë¦„) Ã— 3.14
                            </div>
                        </div>
                    </div>
                `;
            }
            panel.innerHTML = html;
        }

        // --- ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ---
        function onPointerDown(e) {
            if(currentTab !== 'circumference') return;
            const rect = canvas.getBoundingClientRect();
            const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
            const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
            
            const groundY = canvas.height * 0.7;
            const hitRadius = radiusPx + 60;
            
            if (Math.abs(x - rollX) < hitRadius && Math.abs(y - (groundY - radiusPx)) < hitRadius) {
                isDragging = true;
                lastPointerX = e.touches ? e.touches[0].clientX : e.clientX;
                bubble.classList.remove('hidden'); 
            }
        }

        function onPointerMove(e) {
            if (!isDragging) return;
            e.preventDefault(); 
            const cx = e.touches ? e.touches[0].clientX : e.clientX;
            const dx = cx - lastPointerX;
            lastPointerX = cx;

            rollX += dx;
            if (rollX < rollStartX) rollX = rollStartX;
            
            const maxDist = diameterCm * Math.PI * pixelsPerCm;
            if (rollX > rollStartX + maxDist) rollX = rollStartX + maxDist;

            draw();
        }

        function onPointerUp() {
            isDragging = false;
        }

        function resetPosition() {
            // ìœ„ì¹˜ ë¦¬ì…‹ì€ í˜„ì¬ í™”ë©´ ë¹„ìœ¨ì— ë§ì¶°ì„œ
            const w = canvas.width;
            rollStartX = w * 0.15;
            rollX = rollStartX;
            
            isFinished = false;
            bubble.classList.add('hidden');
            updateInfoPanel();
            draw();
        }

        // ì‹¤í–‰
        window.onload = init;

    </script>
</body>
</html>